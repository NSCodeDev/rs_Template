name: {{ docker_name.replace('_dev', '_stage') }}

services:
  {{ docker_api_container_name }}:
    build:
      context: .
      dockerfile: Dockerfile.stage
    env_file: ./.env
    environment:
      PORT: {{ stage_server_port }}
{%- if use_postgres %}
      DB_HOST: advensis_postgres_stage
{%- endif %}
      APP_ENV: staging
      ENVIRONMENT: staging
    ports: 
      - "{{ stage_server_port }}:{{ stage_server_port }}"
    command: ["/app/entrypoint.sh"]
    restart: unless-stopped
    networks: 
      - app_stage_network
    container_name: {{ docker_api_container_name }}-stage
    mem_limit: "512m"
    cpus: "0.5"
{%- if use_postgres %}
    depends_on:
      - postgres-stage
{%- endif %}


{%- if use_celery %}

  celery-worker-stage:
    build:
      context: .
      dockerfile: Dockerfile.stage
    env_file: ./.env
    command: celery -A config worker -l info
    depends_on:
      - {{ docker_api_container_name }}
    networks:
      - app_stage_network
    container_name: {{ project_slug }}-celery-worker-stage
    restart: unless-stopped

  celery-beat-stage:
    build:
      context: .
      dockerfile: Dockerfile.stage
    env_file: ./.env
    command: celery -A config beat -l info
    depends_on:
      - {{ docker_api_container_name }}
    networks:
      - app_stage_network
    container_name: {{ project_slug }}-celery-beat-stage
    restart: unless-stopped
{%- endif %}

networks:
  app_stage_network:
    external: true
    name: app_stage_network